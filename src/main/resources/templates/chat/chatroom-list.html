<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>채팅방 목록 - Anonymous Chat</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- layout.html 의 content fragment 교체 -->
<div th:replace="layout :: content">
	<section>
		<h2>내 채팅방</h2>
		<div id="chatroom-list"></div>
	</section>
</div>
<script src="/js/csrfFetch.js"></script>
<script>
    const chatroomListContainer = document.getElementById("chatroom-list");

    // 채팅방 목록 조회
    csrfFetch("/api/v1/chatrooms", {
        method: "GET",
        headers: { "Content-Type": "application/json" }
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                renderChatroomList(data.data);
            } else {
                chatroomListContainer.innerHTML = "<p>채팅방을 불러오지 못했습니다.</p>";
            }
        })
        .catch(err => {
            chatroomListContainer.innerHTML = "<p>에러 발생: " + err + "</p>";
        });

    // 채팅방 목록 렌더링
    function renderChatroomList(rooms) {
        chatroomListContainer.innerHTML = "";

        if (!rooms || rooms.length === 0) {
            chatroomListContainer.innerHTML = "<p>참여 중인 채팅방이 없습니다.</p>";
            return;
        }

        rooms.forEach(room => {
            const card = document.createElement("div");
            card.className = "card";

            const profileImage = room.opponentProfileImageUrl ? room.opponentProfileImageUrl : "/images/default-profile.png";
            const lastMessageTime = room.lastMessageTime ? new Date(room.lastMessageTime).toLocaleString() : "메시지 없음";

            card.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <img src="${profileImage}"
                         alt="상대방 프로필"
                         style="width:60px; height:60px; border-radius:50%; margin-right:15px;">
                    <div>
                        <h3>${room.opponentNickname} (${room.opponentAge}세)</h3>
                        <p>${room.opponentRegion}</p>
                        <p>마지막 메시지: ${lastMessageTime}</p>
                        <button onclick="location.href='/chatrooms/${room.roomId}'">채팅방 입장</button>
                    </div>
                </div>
            `;
            chatroomListContainer.appendChild(card);
        });
    }
</script>
</body>
</html>
