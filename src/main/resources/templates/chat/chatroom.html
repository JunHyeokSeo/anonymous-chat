<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>채팅방 - Anonymous Chat</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
	<style>
        #chat-messages {
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
        }
        .message { margin-bottom: 10px; }
        .mine { text-align: right; color: #2D9CDB; }
        .opponent { text-align: left; color: #333; }
        #chat-input { display: flex; margin-top: 10px; }
        #chat-input input {
            flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;
        }
        #chat-input button { margin-left: 8px; }
	</style>
</head>
<body>
<div th:replace="layout :: content">
	<section>
		<h2>채팅방</h2>
		<div id="chat-messages"></div>
		<div id="chat-input">
			<input type="text" id="messageBox" placeholder="메시지를 입력하세요">
			<button id="sendBtn">전송</button>
		</div>
	</section>
</div>
<script src="/js/csrfFetch.js"></script>
<script>
    // URL에서 roomId 추출
    const pathParts = window.location.pathname.split("/");
    const roomId = parseInt(pathParts[pathParts.length - 1]);

    // JWT 토큰 (실제 구현에서는 localStorage나 cookie에서 가져오기)
    const token = localStorage.getItem("accessToken");

    const chatContainer = document.getElementById("chat-messages");

    // 1. 채팅 히스토리 로드
    function loadHistory() {
        csrfFetch(`/api/v1/messages?roomId=${roomId}&limit=30`, {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            }
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    data.data.forEach(msg => renderMessage(msg));
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } else {
                    console.warn("메시지 불러오기 실패:", data.error?.message);
                }
            })
            .catch(err => console.error("메시지 불러오기 오류:", err));
    }

    // 2. WebSocket 연결
    let socket;
    if (token) {
        socket = new SockJS("/ws/chat?token=" + token); // JwtHandshakeInterceptor에서 검증
        socket.onopen = () => {
            console.log("WebSocket 연결됨");
            // 채팅방 입장 이벤트
            sendMessage("ENTER", null);
        };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            renderMessage(msg);
        };

        socket.onclose = () => console.log("WebSocket 연결 종료");
        socket.onerror = (err) => console.error("WebSocket 오류:", err);
    } else {
        alert("로그인이 필요합니다.");
        window.location.href = "/login";
    }

    // 3. 메시지 전송
    document.getElementById("sendBtn").addEventListener("click", () => {
        const content = document.getElementById("messageBox").value.trim();
        if (content) {
            sendMessage("CHAT", content);
            document.getElementById("messageBox").value = "";
        }
    });

    function sendMessage(type, content) {
        const msg = { roomId: roomId, type: type, content: content };
        socket.send(JSON.stringify(msg));
    }

    // 4. 메시지 렌더링
    function renderMessage(msg) {
        const div = document.createElement("div");
        div.classList.add("message");

        if (msg.isMine || (msg.senderId && msg.senderId === getMyUserId())) {
            div.classList.add("mine");
        } else {
            div.classList.add("opponent");
        }

        if (msg.type === "CHAT") {
            div.textContent = msg.content;
        } else if (msg.type === "ENTER") {
            div.textContent = "상대방이 입장했습니다.";
        } else if (msg.type === "LEAVE") {
            div.textContent = "상대방이 퇴장했습니다.";
        } else if (msg.type === "READ") {
            div.textContent = "상대방이 메시지를 읽었습니다.";
        }

        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // 5. 내 userId 가져오기 (실제 구현에서는 JWT 클레임 기반)
    function getMyUserId() {
        return parseInt(localStorage.getItem("userId"));
    }

    // 6. 퇴장 이벤트
    window.addEventListener("beforeunload", () => {
        sendMessage("LEAVE", null);
    });

    // 페이지 진입 시 히스토리 먼저 로드
    loadHistory();
</script>
</body>
</html>
