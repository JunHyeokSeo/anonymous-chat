<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ìµëª… ì±„íŒ…</title>
	<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 64px);
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .filter-select {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .user-details {
            font-size: 0.8rem;
            color: #666;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .empty-subtext {
            color: #999;
        }

        .chat-rooms-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-room-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
            border: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-room-item:hover {
            background: #f8f9fa;
        }

        .chat-room-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .room-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .room-info {
            flex: 1;
            min-width: 0;
        }

        .room-name {
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-last-message {
            font-size: 0.8rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-time {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 8px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            cursor: pointer;
            border-radius: 6px;
        }

        .pagination button:hover {
            background: #f0f0f0;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 50%;
            }

            .chat-area {
                height: 50%;
            }
        }
	</style>
</head>
<body>
<div class="header">
	<div class="logo">ìµëª…ì±„íŒ…</div>
	<div class="header-actions">
		<span id="userNickname">ë¡œë”©ì¤‘...</span>
		<button class="header-btn" onclick="showProfile()">í”„ë¡œí•„</button>
		<button class="header-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
	</div>
</div>

<div class="main-container">
	<div class="sidebar">
		<!-- ì±„íŒ…ë°© ëª©ë¡ ì„¹ì…˜ -->
		<div class="chat-rooms-section">
			<h3 class="section-title">ì§„í–‰ì¤‘ì¸ ì±„íŒ…</h3>
			<div id="chatRoomsList">
				<div class="loading">ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
			</div>
		</div>

		<!-- ì‚¬ìš©ì ê²€ìƒ‰ ì„¹ì…˜ -->
		<div class="sidebar-header">
			<div class="search-section">
				<h3 class="section-title">ìƒˆë¡œìš´ ì‚¬ëŒ ì°¾ê¸°</h3>
				<div class="search-filters">
					<select id="genderFilter" class="filter-select">
						<option value="">ì„±ë³„</option>
						<option value="MALE">ë‚¨ì„±</option>
						<option value="FEMALE">ì—¬ì„±</option>
					</select>
					<select id="regionFilter" class="filter-select">
						<option value="">ì§€ì—­</option>
						<option value="SEOUL">ì„œìš¸</option>
						<option value="BUSAN">ë¶€ì‚°</option>
						<option value="DAEGU">ëŒ€êµ¬</option>
						<option value="INCHEON">ì¸ì²œ</option>
						<option value="GWANGJU">ê´‘ì£¼</option>
						<option value="DAEJEON">ëŒ€ì „</option>
						<option value="ULSAN">ìš¸ì‚°</option>
						<option value="SEJONG">ì„¸ì¢…</option>
						<option value="GYEONGGI">ê²½ê¸°</option>
						<option value="GANGWON">ê°•ì›</option>
						<option value="CHUNGBUK">ì¶©ë¶</option>
						<option value="CHUNGNAM">ì¶©ë‚¨</option>
						<option value="JEONBUK">ì „ë¶</option>
						<option value="JEONNAM">ì „ë‚¨</option>
						<option value="GYEONGBUK">ê²½ë¶</option>
						<option value="GYEONGNAM">ê²½ë‚¨</option>
						<option value="JEJU">ì œì£¼</option>
					</select>
					<input type="number" id="minAgeFilter" class="filter-select" placeholder="ìµœì†Œë‚˜ì´" min="0" max="100">
					<input type="number" id="maxAgeFilter" class="filter-select" placeholder="ìµœëŒ€ë‚˜ì´" min="0" max="100">
				</div>
				<button class="search-btn" onclick="searchUsers()">ì‚¬ìš©ì ê²€ìƒ‰</button>
			</div>
		</div>

		<div class="user-list" id="userList">
			<div class="empty-chat">
				<div class="empty-icon">ğŸ”</div>
				<div class="empty-text">ê²€ìƒ‰ ì¡°ê±´ì„ ì„¤ì •í•˜ê³ </div>
				<div class="empty-subtext">ìƒˆë¡œìš´ ì‚¬ëŒì„ ì°¾ì•„ë³´ì„¸ìš”</div>
			</div>
		</div>
	</div>

	<div class="chat-area">
		<div class="empty-chat">
			<div class="empty-icon">ğŸ’¬</div>
			<div class="empty-text">ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”</div>
			<div class="empty-subtext">ì™¼ìª½ì—ì„œ ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</div>
		</div>
	</div>
</div>

<script>
    let currentPage = 0;
    let currentUser = null;
    let chatRooms = [];
    let selectedRoomId = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        loadMyProfile();
        loadChatRooms();
    });

    // ì¸ì¦ í™•ì¸
    function checkAuth() {
        const accessToken = sessionStorage.getItem('accessToken');
        if (!accessToken) {
            window.location.href = '/login';
            return false;
        }
        return true;
    }

    // API í˜¸ì¶œ í—¬í¼ í•¨ìˆ˜
    async function apiCall(url, options = {}) {
        const accessToken = sessionStorage.getItem('accessToken');
        const defaultHeaders = {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        };

        const response = await fetch(url, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        });

        if (response.status === 401) {
            // í† í° ë§Œë£Œ ì‹œ ë¦¬í”„ë ˆì‹œ ì‹œë„
            const refreshed = await refreshToken();
            if (refreshed) {
                // ì¬ì‹œë„
                return apiCall(url, options);
            } else {
                window.location.href = '/login';
                return null;
            }
        }

        return response;
    }

    // í† í° ë¦¬í”„ë ˆì‹œ
    async function refreshToken() {
        try {
            const response = await fetch('/api/v1/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
                },
                credentials: 'include'
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    sessionStorage.setItem('accessToken', result.data.accessToken);
                    return true;
                }
            }
            return false;
        } catch (error) {
            console.error('Token refresh failed:', error);
            return false;
        }
    }

    // ì¿ í‚¤ ì½ê¸°
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // ë‚´ í”„ë¡œí•„ ë¡œë“œ
    async function loadMyProfile() {
        try {
            const response = await apiCall('/api/v1/users/me');
            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    currentUser = result.data;
                    document.getElementById('userNickname').textContent = currentUser.nickname;
                }
            }
        } catch (error) {
            console.error('Failed to load profile:', error);
        }
    }

    // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
    async function loadChatRooms() {
        try {
            const response = await apiCall('/api/v1/chatrooms');
            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    chatRooms = result.data;
                    renderChatRooms();
                }
            }
        } catch (error) {
            console.error('Failed to load chat rooms:', error);
            document.getElementById('chatRoomsList').innerHTML = '<div class="loading">ì±„íŒ…ë°©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
    function renderChatRooms() {
        const container = document.getElementById('chatRoomsList');

        if (chatRooms.length === 0) {
            container.innerHTML = '<div class="empty-chat"><div class="empty-text">ì§„í–‰ì¤‘ì¸ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div></div>';
            return;
        }

        container.innerHTML = chatRooms.map(room => `
                <div class="chat-room-item" onclick="selectChatRoom(${room.roomId})">
                    <div class="room-avatar">${room.opponentNickname.charAt(0)}</div>
                    <div class="room-info">
                        <div class="room-name">${room.opponentNickname}</div>
                        <div class="room-last-message">${room.opponentAge}ì„¸ Â· ${getRegionName(room.opponentRegion)}</div>
                    </div>
                    <div class="room-time">${formatTime(room.lastMessageTime)}</div>
                </div>
            `).join('');
    }

    // ì‚¬ìš©ì ê²€ìƒ‰
    async function searchUsers() {
        const filters = {
            gender: document.getElementById('genderFilter').value || null,
            region: document.getElementById('regionFilter').value || null,
            minAge: parseInt(document.getElementById('minAgeFilter').value) || null,
            maxAge: parseInt(document.getElementById('maxAgeFilter').value) || null
        };

        // ë¹ˆ í•„í„° ì œê±°
        const searchParams = Object.entries(filters)
            .filter(([key, value]) => value !== null)
            .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});

        const queryString = new URLSearchParams({
            ...searchParams,
            page: 0,
            size: 20
        }).toString();

        try {
            document.getElementById('userList').innerHTML = '<div class="loading">ê²€ìƒ‰ ì¤‘...</div>';

            const response = await apiCall(`/api/v1/users?${queryString}`);
            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    renderUserList(result.data.content);
                }
            }
        } catch (error) {
            console.error('Search failed:', error);
            document.getElementById('userList').innerHTML = '<div class="loading">ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§
    function renderUserList(users) {
        const container = document.getElementById('userList');

        if (users.length === 0) {
            container.innerHTML = '<div class="empty-chat"><div class="empty-text">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
            return;
        }

        container.innerHTML = users.map(user => `
                <div class="user-item" onclick="startChat(${user.userId})">
                    <div class="user-avatar">${user.nickname.charAt(0)}</div>
                    <div class="user-info">
                        <div class="user-name">${user.nickname}</div>
                        <div class="user-details">${user.age}ì„¸ Â· ${getRegionName(user.region)}</div>
                    </div>
                </div>
            `).join('');
    }

    // ì±„íŒ… ì‹œì‘
    async function startChat(recipientId) {
        try {
            const response = await apiCall('/api/v1/chatrooms', {
                method: 'POST',
                body: JSON.stringify({ recipientId })
            });

            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    selectChatRoom(result.data.roomId);
                    loadChatRooms(); // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }
            }
        } catch (error) {
            console.error('Failed to start chat:', error);
            alert('ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    // ì±„íŒ…ë°© ì„ íƒ
    function selectChatRoom(roomId) {
        selectedRoomId = roomId;

        // ì±„íŒ…ë°© í™œì„±í™” í‘œì‹œ
        document.querySelectorAll('.chat-room-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget?.classList.add('active');

        // ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = `/chat/${roomId}`;
    }

    // í”„ë¡œí•„ ë³´ê¸°
    function showProfile() {
        // ëª¨ë‹¬ì´ë‚˜ ìƒˆ í˜ì´ì§€ë¡œ í”„ë¡œí•„ í‘œì‹œ
        window.location.href = '/profile';
    }

    // ë¡œê·¸ì•„ì›ƒ
    async function logout() {
        try {
            await apiCall('/api/v1/auth/logout', { method: 'POST' });
        } catch (error) {
            console.error('Logout error:', error);
        } finally {
            sessionStorage.removeItem('accessToken');
            document.cookie = 'refreshToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/login';
        }
    }

    // ì§€ì—­ëª… ë³€í™˜
    function getRegionName(region) {
        const regions = {
            'SEOUL': 'ì„œìš¸',
            'BUSAN': 'ë¶€ì‚°',
            'DAEGU': 'ëŒ€êµ¬',
            'INCHEON': 'ì¸ì²œ',
            'GWANGJU': 'ê´‘ì£¼',
            'DAEJEON': 'ëŒ€ì „',
            'ULSAN': 'ìš¸ì‚°',
            'SEJONG': 'ì„¸ì¢…',
            'GYEONGGI': 'ê²½ê¸°',
            'GANGWON': 'ê°•ì›',
            'CHUNGBUK': 'ì¶©ë¶',
            'CHUNGNAM': 'ì¶©ë‚¨',
            'JEONBUK': 'ì „ë¶',
            'JEONNAM': 'ì „ë‚¨',
            'GYEONGBUK': 'ê²½ë¶',
            'GYEONGNAM': 'ê²½ë‚¨',
            'JEJU': 'ì œì£¼',
            'UNKNOWN': 'ê¸°íƒ€'
        };
        return regions[region] || region;
    }

    // ì‹œê°„ í¬ë§·íŒ…
    function formatTime(dateString) {
        if (!dateString) return '';

        const date = new Date(dateString);
        const now = new Date();
        const diff = now.getTime() - date.getTime();

        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (minutes < 1) return 'ë°©ê¸ˆ';
        if (minutes < 60) return `${minutes}ë¶„ ì „`;
        if (hours < 24) return `${hours}ì‹œê°„ ì „`;
        if (days < 7) return `${days}ì¼ ì „`;

        return date.toLocaleDateString();
    }
</script>
</body>
</html>