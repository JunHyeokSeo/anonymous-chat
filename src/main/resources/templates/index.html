<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>익명 채팅</title>
	<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 64px);
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .filter-select {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .user-details {
            font-size: 0.8rem;
            color: #666;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .empty-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            padding: 40px;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .empty-subtext {
            color: #999;
        }

        .chat-rooms-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-room-item {
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
            border: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-room-item:hover {
            background: #f8f9fa;
        }

        .chat-room-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .room-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .room-info {
            flex: 1;
            min-width: 0;
        }

        .room-name {
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-last-message {
            font-size: 0.8rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-time {
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 8px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            cursor: pointer;
            border-radius: 6px;
        }

        .pagination button:hover {
            background: #f0f0f0;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 50%;
            }

            .chat-area {
                height: 50%;
            }
        }
	</style>
</head>
<body>
<div class="header">
	<div class="logo">익명채팅</div>
	<div class="header-actions">
		<span id="userNickname">로딩중...</span>
		<button class="header-btn" onclick="showProfile()">프로필</button>
		<button class="header-btn" onclick="logout()">로그아웃</button>
	</div>
</div>

<div class="main-container">
	<div class="sidebar">
		<!-- 채팅방 목록 섹션 -->
		<div class="chat-rooms-section">
			<h3 class="section-title">진행중인 채팅</h3>
			<div id="chatRoomsList">
				<div class="loading">채팅방을 불러오는 중...</div>
			</div>
		</div>

		<!-- 사용자 검색 섹션 -->
		<div class="sidebar-header">
			<div class="search-section">
				<h3 class="section-title">새로운 사람 찾기</h3>
				<div class="search-filters">
					<select id="genderFilter" class="filter-select">
						<option value="">성별</option>
						<option value="MALE">남성</option>
						<option value="FEMALE">여성</option>
					</select>
					<select id="regionFilter" class="filter-select">
						<option value="">지역</option>
						<option value="SEOUL">서울</option>
						<option value="BUSAN">부산</option>
						<option value="DAEGU">대구</option>
						<option value="INCHEON">인천</option>
						<option value="GWANGJU">광주</option>
						<option value="DAEJEON">대전</option>
						<option value="ULSAN">울산</option>
						<option value="SEJONG">세종</option>
						<option value="GYEONGGI">경기</option>
						<option value="GANGWON">강원</option>
						<option value="CHUNGBUK">충북</option>
						<option value="CHUNGNAM">충남</option>
						<option value="JEONBUK">전북</option>
						<option value="JEONNAM">전남</option>
						<option value="GYEONGBUK">경북</option>
						<option value="GYEONGNAM">경남</option>
						<option value="JEJU">제주</option>
					</select>
					<input type="number" id="minAgeFilter" class="filter-select" placeholder="최소나이" min="0" max="100">
					<input type="number" id="maxAgeFilter" class="filter-select" placeholder="최대나이" min="0" max="100">
				</div>
				<button class="search-btn" onclick="searchUsers()">사용자 검색</button>
			</div>
		</div>

		<div class="user-list" id="userList">
			<div class="empty-chat">
				<div class="empty-icon">🔍</div>
				<div class="empty-text">검색 조건을 설정하고</div>
				<div class="empty-subtext">새로운 사람을 찾아보세요</div>
			</div>
		</div>
	</div>

	<div class="chat-area">
		<div class="empty-chat">
			<div class="empty-icon">💬</div>
			<div class="empty-text">대화를 시작해보세요</div>
			<div class="empty-subtext">왼쪽에서 사용자를 선택하거나 채팅방을 선택하세요</div>
		</div>
	</div>
</div>

<script>
    let currentPage = 0;
    let currentUser = null;
    let chatRooms = [];
    let selectedRoomId = null;

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        checkAuth();
        loadMyProfile();
        loadChatRooms();
    });

    // 인증 확인
    function checkAuth() {
        const accessToken = sessionStorage.getItem('accessToken');
        if (!accessToken) {
            window.location.href = '/login';
            return false;
        }
        return true;
    }

    // API 호출 헬퍼 함수
    async function apiCall(url, options = {}) {
        const accessToken = sessionStorage.getItem('accessToken');
        const defaultHeaders = {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        };

        const response = await fetch(url, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        });

        if (response.status === 401) {
            // 토큰 만료 시 리프레시 시도
            const refreshed = await refreshToken();
            if (refreshed) {
                // 재시도
                return apiCall(url, options);
            } else {
                window.location.href = '/login';
                return null;
            }
        }

        return response;
    }

    // 토큰 리프레시
    async function refreshToken() {
        try {
            const response = await fetch('/api/v1/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
                },
                credentials: 'include'
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    sessionStorage.setItem('accessToken', result.data.accessToken);
                    return true;
                }
            }
            return false;
        } catch (error) {
            console.error('Token refresh failed:', error);
            return false;
        }
    }

    // 쿠키 읽기
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    // 내 프로필 로드
    async function loadMyProfile() {
        try {
            const response = await apiCall('/api/v1/users/me');
            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    currentUser = result.data;
                    document.getElementById('userNickname').textContent = currentUser.nickname;
                }
            }
        } catch (error) {
            console.error('Failed to load profile:', error);
        }
    }

    // 채팅방 목록 로드
    async function loadChatRooms() {
        try {
            const response = await apiCall('/api/v1/chatrooms');
            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    chatRooms = result.data;
                    renderChatRooms();
                }
            }
        } catch (error) {
            console.error('Failed to load chat rooms:', error);
            document.getElementById('chatRoomsList').innerHTML = '<div class="loading">채팅방을 불러올 수 없습니다.</div>';
        }
    }

    // 채팅방 목록 렌더링
    function renderChatRooms() {
        const container = document.getElementById('chatRoomsList');

        if (chatRooms.length === 0) {
            container.innerHTML = '<div class="empty-chat"><div class="empty-text">진행중인 채팅이 없습니다</div></div>';
            return;
        }

        container.innerHTML = chatRooms.map(room => `
                <div class="chat-room-item" onclick="selectChatRoom(${room.roomId})">
                    <div class="room-avatar">${room.opponentNickname.charAt(0)}</div>
                    <div class="room-info">
                        <div class="room-name">${room.opponentNickname}</div>
                        <div class="room-last-message">${room.opponentAge}세 · ${getRegionName(room.opponentRegion)}</div>
                    </div>
                    <div class="room-time">${formatTime(room.lastMessageTime)}</div>
                </div>
            `).join('');
    }

    // 사용자 검색
    async function searchUsers() {
        const filters = {
            gender: document.getElementById('genderFilter').value || null,
            region: document.getElementById('regionFilter').value || null,
            minAge: parseInt(document.getElementById('minAgeFilter').value) || null,
            maxAge: parseInt(document.getElementById('maxAgeFilter').value) || null
        };

        // 빈 필터 제거
        const searchParams = Object.entries(filters)
            .filter(([key, value]) => value !== null)
            .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});

        const queryString = new URLSearchParams({
            ...searchParams,
            page: 0,
            size: 20
        }).toString();

        try {
            document.getElementById('userList').innerHTML = '<div class="loading">검색 중...</div>';

            const response = await apiCall(`/api/v1/users?${queryString}`);
            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    renderUserList(result.data.content);
                }
            }
        } catch (error) {
            console.error('Search failed:', error);
            document.getElementById('userList').innerHTML = '<div class="loading">검색에 실패했습니다.</div>';
        }
    }

    // 사용자 목록 렌더링
    function renderUserList(users) {
        const container = document.getElementById('userList');

        if (users.length === 0) {
            container.innerHTML = '<div class="empty-chat"><div class="empty-text">검색 결과가 없습니다</div></div>';
            return;
        }

        container.innerHTML = users.map(user => `
                <div class="user-item" onclick="startChat(${user.userId})">
                    <div class="user-avatar">${user.nickname.charAt(0)}</div>
                    <div class="user-info">
                        <div class="user-name">${user.nickname}</div>
                        <div class="user-details">${user.age}세 · ${getRegionName(user.region)}</div>
                    </div>
                </div>
            `).join('');
    }

    // 채팅 시작
    async function startChat(recipientId) {
        try {
            const response = await apiCall('/api/v1/chatrooms', {
                method: 'POST',
                body: JSON.stringify({ recipientId })
            });

            if (response && response.ok) {
                const result = await response.json();
                if (result.success) {
                    selectChatRoom(result.data.roomId);
                    loadChatRooms(); // 채팅방 목록 새로고침
                }
            }
        } catch (error) {
            console.error('Failed to start chat:', error);
            alert('채팅을 시작할 수 없습니다.');
        }
    }

    // 채팅방 선택
    function selectChatRoom(roomId) {
        selectedRoomId = roomId;

        // 채팅방 활성화 표시
        document.querySelectorAll('.chat-room-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget?.classList.add('active');

        // 채팅 페이지로 이동
        window.location.href = `/chat/${roomId}`;
    }

    // 프로필 보기
    function showProfile() {
        // 모달이나 새 페이지로 프로필 표시
        window.location.href = '/profile';
    }

    // 로그아웃
    async function logout() {
        try {
            await apiCall('/api/v1/auth/logout', { method: 'POST' });
        } catch (error) {
            console.error('Logout error:', error);
        } finally {
            sessionStorage.removeItem('accessToken');
            document.cookie = 'refreshToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/login';
        }
    }

    // 지역명 변환
    function getRegionName(region) {
        const regions = {
            'SEOUL': '서울',
            'BUSAN': '부산',
            'DAEGU': '대구',
            'INCHEON': '인천',
            'GWANGJU': '광주',
            'DAEJEON': '대전',
            'ULSAN': '울산',
            'SEJONG': '세종',
            'GYEONGGI': '경기',
            'GANGWON': '강원',
            'CHUNGBUK': '충북',
            'CHUNGNAM': '충남',
            'JEONBUK': '전북',
            'JEONNAM': '전남',
            'GYEONGBUK': '경북',
            'GYEONGNAM': '경남',
            'JEJU': '제주',
            'UNKNOWN': '기타'
        };
        return regions[region] || region;
    }

    // 시간 포맷팅
    function formatTime(dateString) {
        if (!dateString) return '';

        const date = new Date(dateString);
        const now = new Date();
        const diff = now.getTime() - date.getTime();

        const minutes = Math.floor(diff / (1000 * 60));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        if (minutes < 1) return '방금';
        if (minutes < 60) return `${minutes}분 전`;
        if (hours < 24) return `${hours}시간 전`;
        if (days < 7) return `${days}일 전`;

        return date.toLocaleDateString();
    }
</script>
</body>
</html>