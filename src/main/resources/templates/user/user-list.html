<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>유저 목록 - Anonymous Chat</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- layout.html 의 content fragment 교체 -->
<div th:replace="layout :: content">
	<section>
		<h2>유저 검색</h2>
		<form id="search-form" class="card">
			<label>성별</label>
			<label>
				<select name="gender">
					<option value="">전체</option>
					<option value="MALE">남성</option>
					<option value="FEMALE">여성</option>
					<option value="NONE">선택 안함</option>
				</select>
			</label>

			<label>나이</label>
			<label>
				<input type="number" name="minAge" placeholder="최소" min="0" max="100">
			</label>
			~
			<label>
				<input type="number" name="maxAge" placeholder="최대" min="0" max="100">
			</label>

			<label>지역</label>
			<label>
				<select name="region">
					<option value="">전체</option>
					<option value="SEOUL">서울</option>
					<option value="BUSAN">부산</option>
					<option value="DAEGU">대구</option>
					<option value="INCHEON">인천</option>
					<option value="GWANGJU">광주</option>
					<option value="DAEJEON">대전</option>
					<option value="ULSAN">울산</option>
					<option value="SEJONG">세종</option>
					<option value="GYEONGGI">경기</option>
					<option value="GANGWON">강원</option>
					<option value="CHUNGBUK">충북</option>
					<option value="CHUNGNAM">충남</option>
					<option value="JEONBUK">전북</option>
					<option value="JEONNAM">전남</option>
					<option value="GYEONGBUK">경북</option>
					<option value="GYEONGNAM">경남</option>
					<option value="JEJU">제주</option>
				</select>
			</label>

			<button type="submit">검색</button>
		</form>

		<h2>유저 목록</h2>
		<div id="user-list"></div>
	</section>
</div>

<script>
    const userListContainer = document.getElementById("user-list");

    // 검색 폼 이벤트
    document.getElementById("search-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const params = new URLSearchParams();

        if (form.gender.value) params.append("gender", form.gender.value);
        if (form.minAge.value) params.append("minAge", form.minAge.value);
        if (form.maxAge.value) params.append("maxAge", form.maxAge.value);
        if (form.region.value) params.append("region", form.region.value);

        // 페이징 기본값
        params.append("page", "0");
        params.append("size", "20");

        fetch("/api/v1/users?" + params.toString(), {
            method: "GET",
            headers: { "Content-Type": "application/json" }
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    renderUserList(data.data.content);
                } else {
                    alert("검색 실패: " + data.error?.message);
                }
            })
            .catch(err => alert("오류 발생: " + err));
    });

    // 유저 목록 렌더링
    function renderUserList(users) {
        userListContainer.innerHTML = ""; // 초기화
        if (users.length === 0) {
            userListContainer.innerHTML = "<p>검색 결과가 없습니다.</p>";
            return;
        }

        users.forEach(user => {
            const card = document.createElement("div");
            card.className = "card";

            card.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <img src="${user.profileImageUrl || '/images/default-profile.png'}"
                         alt="프로필 이미지"
                         style="width:60px; height:60px; border-radius:50%; margin-right:15px;">
                    <div>
                        <h3>${user.nickname} (${user.age}세)</h3>
                        <p>${user.region}</p>
                        <p>마지막 활동: ${new Date(user.lastActiveAt).toLocaleString()}</p>
                        <button onclick="location.href='/users/${user.userId}'">프로필 보기</button>
                    </div>
                </div>
            `;
            userListContainer.appendChild(card);
        });
    }
</script>
</body>
</html>
