<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>유저 상세 - Anonymous Chat</title>
	<link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- layout.html 의 content fragment 교체 -->
<div th:replace="layout :: content">
	<section id="user-detail" class="card">
		<h2>유저 상세</h2>
		<div id="profile"></div>
		<div style="margin-top:15px;">
			<button id="chat-btn">채팅 시작</button>
			<button id="block-btn" style="background:#e74c3c;">차단하기</button>
		</div>
	</section>
</div>
<script src="/js/csrfFetch.js"></script>
<script>
    // 현재 URL에서 userId 추출
    const pathParts = window.location.pathname.split("/");
    const userId = pathParts[pathParts.length - 1];

    const profileContainer = document.getElementById("profile");
    const chatBtn = document.getElementById("chat-btn");
    const blockBtn = document.getElementById("block-btn");

    // 유저 상세 조회 (API에 맞춰 수정 필요)
    csrfFetch("/api/v1/users/" + userId, {
        method: "GET",
        headers: { "Content-Type": "application/json" }
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const user = data.data;
                renderUserDetail(user);
            } else {
                profileContainer.innerHTML = "<p>유저 정보를 불러오지 못했습니다.</p>";
            }
        })
        .catch(err => {
            profileContainer.innerHTML = "<p>에러 발생: " + err + "</p>";
        });

    function renderUserDetail(user) {
        const profileImage = user.profileImageUrl ? user.profileImageUrl : "/images/default-profile.png";
        const lastActive = user.lastActiveAt ? new Date(user.lastActiveAt).toLocaleString() : "정보 없음";

        profileContainer.innerHTML = `
            <div style="display:flex; align-items:center;">
                <img src="${profileImage}" alt="프로필 이미지"
                     style="width:100px; height:100px; border-radius:50%; margin-right:20px;">
                <div>
                    <h3>${user.nickname} (${user.age}세)</h3>
                    <p>성별: ${user.gender}</p>
                    <p>지역: ${user.region}</p>
                    <p>자기소개: ${user.bio || "소개 없음"}</p>
                    <p>마지막 활동: ${lastActive}</p>
                </div>
            </div>
        `;
    }

    // 채팅 시작 버튼
    chatBtn.addEventListener("click", () => {
        csrfFetch("/api/v1/chatrooms", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ recipientId: parseInt(userId) })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const roomId = data.data.roomId;
                    alert("채팅방이 생성되었습니다.");
                    window.location.href = "/chatrooms/" + roomId;
                } else {
                    alert("채팅 시작 실패: " + data.error?.message);
                }
            })
            .catch(err => alert("오류 발생: " + err));
    });

    // 차단 버튼
    blockBtn.addEventListener("click", () => {
        if (!confirm("정말 이 사용자를 차단하시겠습니까?")) return;

        csrfFetch("/api/v1/blocks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ blockedUserId: parseInt(userId) })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("사용자가 차단되었습니다.");
                    window.location.href = "/users";
                } else {
                    alert("차단 실패: " + data.error?.message);
                }
            })
            .catch(err => alert("오류 발생: " + err));
    });
</script>
</body>
</html>