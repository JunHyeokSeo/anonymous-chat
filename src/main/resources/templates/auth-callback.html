<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>로그인 처리중 - 익명채팅</title>
	<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .processing-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 60px 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .processing-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .processing-subtitle {
            color: #666;
            font-size: 1rem;
            margin-bottom: 32px;
        }

        .progress-steps {
            text-align: left;
            margin-bottom: 24px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #666;
            transition: color 0.3s ease;
        }

        .step.completed {
            color: #28a745;
        }

        .step.active {
            color: #667eea;
            font-weight: 600;
        }

        .step-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-container {
            display: none;
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }

        .retry-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 16px;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
	</style>
</head>
<body>
<div class="processing-container">
	<div class="loading-spinner" id="loadingSpinner"></div>

	<h1 class="processing-title">로그인 처리중</h1>
	<p class="processing-subtitle">잠시만 기다려주세요...</p>

	<div class="progress-steps">
		<div class="step completed" id="step1">
			<div class="step-icon">✓</div>
			<span>인증 정보 확인</span>
		</div>
		<div class="step active" id="step2">
			<div class="step-icon">⏳</div>
			<span>토큰 처리중</span>
		</div>
		<div class="step" id="step3">
			<div class="step-icon">⏳</div>
			<span>페이지 이동</span>
		</div>
	</div>

	<div class="error-container" id="errorContainer">
		<strong>로그인 처리 중 오류가 발생했습니다.</strong>
		<p id="errorMessage">잠시 후 다시 시도해주세요.</p>
		<button class="retry-btn" onclick="retryLogin()">다시 시도</button>
	</div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const tokenData = /*[[${tokenData}]]*/ null;
    /*]]>*/

    function updateStep(stepNumber) {
        // 이전 단계들을 완료로 표시
        for (let i = 1; i <= stepNumber; i++) {
            const step = document.getElementById(`step${i}`);
            if (step) {
                step.classList.remove('active');
                step.classList.add('completed');
                step.querySelector('.step-icon').textContent = '✓';
            }
        }

        // 다음 단계를 활성화
        const nextStep = document.getElementById(`step${stepNumber + 1}`);
        if (nextStep) {
            nextStep.classList.add('active');
        }
    }

    function showError(message) {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('errorContainer').style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }

    function retryLogin() {
        window.location.href = '/login';
    }

    async function processAuthentication() {
        try {
            if (!tokenData) {
                throw new Error('인증 데이터가 없습니다.');
            }

            // Step 2: 토큰 저장
            updateStep(1);

            // Access Token을 sessionStorage에 저장
            sessionStorage.setItem('accessToken', tokenData.accessToken);

            // Step 3: 페이지 이동 준비
            updateStep(2);

            await new Promise(resolve => setTimeout(resolve, 500)); // 사용자 경험을 위한 약간의 지연

            updateStep(3);

            // 적절한 페이지로 리다이렉트
            window.location.href = tokenData.isGuestUser ? '/register' : '/';

        } catch (error) {
            console.error('Authentication processing error:', error);
            showError(error.message || '알 수 없는 오류가 발생했습니다.');
        }
    }

    // 페이지 로드 시 자동 실행
    document.addEventListener('DOMContentLoaded', function() {
        // 약간의 지연 후 처리 시작 (로딩 애니메이션 표시)
        setTimeout(processAuthentication, 800);
    });
</script>
</body>
</html>